# ZDT X42S 闭环步进电机通信协议

本文档提取自《ZDT_X42S第二代闭环步进电机用户手册V1.0.3》，详细描述了与张大头闭环步进电机进行通信的协议格式和命令。

## 目录

- [1. 通讯方式概述](#1-通讯方式概述)
- [2. 串口 TTL/RS485 通讯](#2-串口-ttlrs485-通讯)
- [3. CAN 通讯](#3-can-通讯)
- [4. 校验码计算方式](#4-校验码计算方式)
- [5. 通讯命令列表](#5-通讯命令列表)
- [6. 常用命令详解](#6-常用命令详解)

---

## 1. 通讯方式概述

ZDT X42S 支持以下通讯方式：

| 参数 | 说明 |
|------|------|
| 通讯接口 | 串口 TTL / RS485 / CAN |
| 默认波特率 | 115200 (串口) |
| CAN 速率 | 默认 500Kbps |
| 电机地址 | 1-255，0 为广播地址 |
| 校验方式 | 0x6B(固定) / XOR / CRC8 / Modbus-RTU / DMX512 |

### 通讯参数配置

**串口波特率选项 (0x00-0x08)：**
- 0x00: 9600
- 0x01: 19200
- 0x02: 25000
- 0x03: 38400
- 0x04: 57600
- 0x05: 115200 (默认)
- 0x06: 256000
- 0x07: 512000
- 0x08: 921600

**CAN 速率选项 (0x00-0x09)：**
- 0x00: 10K
- 0x01: 20K
- 0x02: 50K
- 0x03: 83.333K
- 0x04: 100K
- 0x05: 125K
- 0x06: 250K
- 0x07: 500K (默认)
- 0x08: 800K
- 0x09: 1M

**校验方式选项 (0x00-0x04)：**
- 0x00: 自由协议，校验码固定为 0x6B (默认)
- 0x01: 自由协议，校验码为 XOR 校验
- 0x02: 自由协议，校验码为 CRC-8 校验
- 0x03: Modbus-RTU 协议
- 0x04: 双协议，自由协议(6B) + DMX512 协议

---

## 2. 串口 TTL/RS485 通讯

### 2.1 主机发送命令格式

| 字段 | 电机地址 | 功能码 | 命令数据 | 校验码 |
|------|----------|--------|----------|--------|
| 说明 | Addr | Code | Data... | 0x6B/XOR/CRC8/Modbus |

- **电机地址(Addr)**: 出厂默认为 1，可设置范围 1-255，0 为广播地址
- **功能码(Code)**: 对应执行相应功能命令
- **命令数据**: 不同命令对应不同的数据内容
- **校验码**: 默认为固定 0x6B

### 2.2 电机返回命令格式

| 字段 | 电机地址 | 功能码 | 返回数据 | 校验码 |
|------|----------|--------|----------|--------|
| 说明 | Addr | Code | 02/12/E2/EE/9F | 0x6B/XOR/CRC8/Modbus |

**返回数据说明：**
- `0x02`: 表示接收的命令正确
- `0x12`: 表示触发回零时，当前就在零点处/当前回零限位已经触发，电机不动
- `0xE2`: 表示接收的命令参数错误，数据范围不满足或条件不满足（触发低压警告、堵转保护、过流过热保护等）
- `0xEE`: 表示接收的命令格式错误
- `0x9F`: 表示动作执行完成命令（电机主动返回）

**动作完成返回命令格式：**
- 力矩模式夹爪夹紧: `地址 + F5 + 9F + 校验码`
- 位置到位返回: `地址 + FB/FD + 9F + 校验码`
- 回零完成: `地址 + 9A + 9F + 校验码`

---

## 3. CAN 通讯

### 3.1 主机发送命令格式

| 字段 | 扩展帧 ID | 功能码 | 命令数据 | 校验码 |
|------|-----------|--------|----------|--------|
| 说明 | (Addr << 8) \| Packet | Code | Data... | 0x6B/XOR/CRC8 |

**重要说明：**
1. CAN 通讯帧类型固定为**扩展帧格式**
2. Addr 为电机地址，Packet 为第几包数据（从 0 开始计数）
3. 对于小于 8 字节数据的命令，Packet 为 0
4. 对于大于 8 字节命令，需要进行拆包发送

**拆包示例：**

命令 `01 FD 01 0F A0 00 00 01 FA 00 00 00 6B` (13字节)

拆分为：
- 第一包: 扩展帧 ID = 0x0100, 数据 = `FD 01 0F A0 00 00 01 FA` (8字节)
- 第二包: 扩展帧 ID = 0x0101, 数据 = `FD 00 00 00 6B` (5字节，以功能码开头)

**注意：** 第二包及后续包的数据也需要以功能码开头。

### 3.2 电机返回命令格式

| 字段 | 扩展帧 ID | 功能码 | 返回数据 | 校验码 |
|------|-----------|--------|----------|--------|
| 说明 | (Addr << 8) \| Packet | Code | 02/E2/EE/9F | 0x6B/XOR/CRC8 |

---

## 4. 校验码计算方式

### 4.1 固定 0x6B 校验

校验码固定为 0x6B，方便测试。

**示例：** 命令 `01 06 45 6B`（校准命令）

### 4.2 XOR 异或校验

校验码为所有前面字节的异或结果。

**示例：** 命令 `01 06 45 XOR`

```
XOR = 0x01 ^ 0x06 ^ 0x45 = 0x42
```

完整命令: `01 06 45 42`

### 4.3 CRC8 校验

使用查表法计算 CRC8 校验码。

**示例：** 命令 `01 06 45 CRC8`

**CRC8 计算代码 (C语言)：**

```c
uint8_t cmd_calCRC8(uint8_t *p, uint8_t len)
{
    unsigned char i = 0, crc8 = p[0];
    for(i = 1; i < len; i++) { 
        crc8 = crc8Table[crc8 ^ (*(p + i))]; 
    }
    return crc8;
}

const uint8_t crc8Table[256] = {
    0x00, 0x5E, 0xBC, 0xE2, 0x61, 0x3F, 0xDD, 0x83, // 0
    0xC2, 0x9C, 0x7E, 0x20, 0xA3, 0xFD, 0x1F, 0x41, // 8
    0x9D, 0xC3, 0x21, 0x7F, 0xFC, 0xA2, 0x40, 0x1E, // 16
    0x5F, 0x01, 0xE3, 0xBD, 0x3E, 0x60, 0x82, 0xDC, // 24
    0x23, 0x7D, 0x9F, 0xC1, 0x42, 0x1C, 0xFE, 0xA0, // 32
    0xE1, 0xBF, 0x5D, 0x03, 0x80, 0xDE, 0x3C, 0x62, // 40
    0xBE, 0xE0, 0x02, 0x5C, 0xDF, 0x81, 0x63, 0x3D, // 48
    0x7C, 0x22, 0xC0, 0x9E, 0x1D, 0x43, 0xA1, 0xFF, // 56
    0x46, 0x18, 0xFA, 0xA4, 0x27, 0x79, 0x9B, 0xC5, // 64
    0x84, 0xDA, 0x38, 0x66, 0xE5, 0xBB, 0x59, 0x07, // 72
    0xDB, 0x85, 0x67, 0x39, 0xBA, 0xE4, 0x06, 0x58, // 80
    0x19, 0x47, 0xA5, 0xFB, 0x78, 0x26, 0xC4, 0x9A, // 88
    0x65, 0x3B, 0xD9, 0x87, 0x04, 0x5A, 0xB8, 0xE6, // 96
    0xA7, 0xF9, 0x1B, 0x45, 0xC6, 0x98, 0x7A, 0x24, // 104
    0xF8, 0xA6, 0x44, 0x1A, 0x99, 0xC7, 0x25, 0x7B, // 112
    0x3A, 0x64, 0x86, 0xD8, 0x5B, 0x05, 0xE7, 0xB9, // 120
    0x8C, 0xD2, 0x30, 0x6E, 0xED, 0xB3, 0x51, 0x0F, // 128
    0x4E, 0x10, 0xF2, 0xAC, 0x2F, 0x71, 0x93, 0xCD, // 136
    0x11, 0x4F, 0xAD, 0xF3, 0x70, 0x2E, 0xCC, 0x92, // 144
    0xD3, 0x8D, 0x6F, 0x31, 0xB2, 0xEC, 0x0E, 0x50, // 152
    0xAF, 0xF1, 0x13, 0x4D, 0xCE, 0x90, 0x72, 0x2C, // 160
    0x6D, 0x33, 0xD1, 0x8F, 0x0C, 0x52, 0xB0, 0xEE, // 168
    0x32, 0x6C, 0x8E, 0xD0, 0x53, 0x0D, 0xEF, 0xB1, // 176
    0xF0, 0xAE, 0x4C, 0x12, 0x91, 0xCF, 0x2D, 0x73, // 184
    0xCA, 0x94, 0x76, 0x28, 0xAB, 0xF5, 0x17, 0x49, // 192
    0x08, 0x56, 0xB4, 0xEA, 0x69, 0x37, 0xD5, 0x8B, // 200
    0x57, 0x09, 0xEB, 0xB5, 0x36, 0x68, 0x8A, 0xD4, // 208
    0x95, 0xCB, 0x29, 0x77, 0xF4, 0xAA, 0x48, 0x16, // 216
    0xE9, 0xB7, 0x55, 0x0B, 0x88, 0xD6, 0x34, 0x6A, // 224
    0x2B, 0x75, 0x97, 0xC9, 0x4A, 0x14, 0xF6, 0xA8, // 232
    0x74, 0x2A, 0xC8, 0x96, 0x15, 0x4B, 0xA9, 0xF7, // 240
    0xB6, 0xE8, 0x0A, 0x54, 0xD7, 0x89, 0x6B, 0x35  // 248
};
```

### 4.4 Modbus-RTU 协议

校验方式为 CRC-16，可参照标准 Modbus 协议计算方式。

---

## 5. 通讯命令列表

### 5.1 触发动作命令

| 功能码 | 辅助码 | 功能描述 |
|--------|--------|----------|
| 0x06 | 0x45 | 触发编码器校准 |
| 0x08 | 0x97 | 重启电机 |
| 0x0A | 0x6D | 将当前位置角度清零 |
| 0x0E | 0x52 | 解除堵转/过热/过流保护 |
| 0x0F | 0x5F | 恢复出厂设置 |

### 5.2 运动控制命令

| 功能码 | 功能描述 |
|--------|----------|
| 0xAA | 多电机命令 |
| 0xF3 | 电机使能控制 |
| 0xF6 | 速度模式控制 |
| 0xFD | 位置模式控制 |
| 0x9A | 回零运动 |
| 0xFE | 电机急停 |

### 5.3 读取参数命令

| 功能码 | 功能描述 |
|--------|----------|
| 0x36 | 读取实时位置角度 |
| 0x37 | 读取实时脉冲数 |
| 0x39 | 读取 IO 状态 |
| 0x3A | 读取电机状态标志 |
| 0x42 | 读取驱动配置参数 |

### 5.4 修改参数命令

| 功能码 | 功能描述 |
|--------|----------|
| 0x48 | 修改驱动配置参数 |

---

## 6. 常用命令详解

### 6.1 触发编码器校准 (0x06)

**主机发送：**
| 地址 | 功能码 | 辅助码 | 校验码 |
|------|--------|--------|--------|
| Addr | 0x06 | 0x45 | 0x6B |

**电机返回：**
| 地址 | 功能码 | 返回数据 | 校验码 |
|------|--------|----------|--------|
| Addr | 0x06 | 02/E2/EE | 0x6B |

**示例：** 发送 `01 06 45 6B`，正确返回 `01 06 02 6B`

电机将缓慢正转一圈然后反转一圈进行编码器线性化校准。不校准编码器将会有 ±0.75° ~ ±1.5° 的误差。

---

### 6.2 将当前位置角度清零 (0x0A)

**主机发送：**
| 地址 | 功能码 | 辅助码 | 校验码 |
|------|--------|--------|--------|
| Addr | 0x0A | 0x6D | 0x6B |

**电机返回：**
| 地址 | 功能码 | 返回数据 | 校验码 |
|------|--------|----------|--------|
| Addr | 0x0A | 02/E2/EE | 0x6B |

**示例：** 发送 `01 0A 6D 6B`，正确返回 `01 0A 02 6B`

---

### 6.3 电机使能控制 (0xF3)

**主机发送：**
| 地址 | 功能码 | 辅助码 | 使能状态 | 同步标志 | 校验码 |
|------|--------|--------|----------|----------|--------|
| Addr | 0xF3 | 0xAB | 00/01 | 00/01 | 0x6B |

- **使能状态**: 00=不使能(松轴)，01=使能(锁轴)
- **同步标志**: 00=立即执行，01=先缓存当前命令

**示例：** 发送 `01 F3 AB 01 00 6B`，正确返回 `01 F3 02 6B`，使能电机（锁轴）

---

### 6.4 速度模式控制 (0xF6)

**主机发送 (8 字节)：**
| 地址 | 功能码 | 方向 | 速度(2字节) | 加速度 | 同步标志 | 校验码 |
|------|--------|------|-------------|--------|----------|--------|
| Addr | 0xF6 | 00/01 | 0000-0BB8 | 00-FF | 00/01 | 0x6B |

- **方向**: 00=CW, 01=CCW
- **速度**: 0-3000 RPM
- **加速度**: 0-255 档位
  - 0 = 直接启动，不使用曲线加减速
  - 非 0 = 加速时间计算公式: t2 - t1 = (256 - acc) × 50μs, Vt2 = Vt1 + 1RPM
  - acc 值越大，加速越快

**示例：** `01 F6 01 05 DC 0A 00 6B`
- 方向: CCW
- 速度: 1500 RPM
- 加速度: 10 档

---

### 6.5 位置模式控制 (0xFD)

**主机发送 (13 字节)：**
| 地址 | 功能码 | 方向 | 速度 | 加速度 | 位置(4字节) | 相对/绝对 | 同步标志 | 校验码 |
|------|--------|------|------|--------|-------------|-----------|----------|--------|
| Addr | 0xFD | 00/01 | 0000-0BB8 | 00-FF | 位置值 | 00/01 | 00/01 | 0x6B |

- **方向**: 00=CW, 01=CCW
- **速度**: 0-3000 RPM
- **加速度**: 0-255 档
- **位置**: 位置角度值（0.1° 精度）
- **相对/绝对**: 00=相对位置, 01=绝对位置
- **同步标志**: 00=立即执行, 01=缓存等待同步命令一起执行

**位置值计算示例：**
- 3600.0° = 0x00008CA0 (36000)
- -3600.0° 相对运动需要设置方向为反方向

---

### 6.6 读取实时位置角度 (0x36)

**主机发送：**
| 地址 | 功能码 | 校验码 |
|------|--------|--------|
| Addr | 0x36 | 0x6B |

**电机返回：**
| 地址 | 功能码 | 位置角度(4字节) | 校验码 |
|------|--------|-----------------|--------|
| Addr | 0x36 | 位置值 | 0x6B |

**示例：** 发送 `01 36 6B`

位置值为有符号 32 位整数，单位 0.1°。

---

### 6.7 电机急停 (0xFE)

**主机发送：**
| 地址 | 功能码 | 辅助码 | 同步标志 | 校验码 |
|------|--------|--------|----------|--------|
| Addr | 0xFE | 0x98 | 00/01 | 0x6B |

**示例：** 发送 `01 FE 98 00 6B`，正确返回 `01 FE 02 6B`，电机立即急停

---

### 6.8 多电机命令 (0xAA)

用于一次发送多个电机的命令，大幅提升多电机控制时的通讯响应速度。

**主机发送：**
| 地址 | 功能码 | 字节长度(2字节) | 命令1 | 命令2 | ... | 校验码 |
|------|--------|-----------------|-------|-------|-----|--------|
| 0x00 | 0xAA | 总字节数 | cmd1 | cmd2 | ... | 0x6B |

- 地址固定为 0x00（广播地址）
- 字节长度为后续所有数据的总字节数

**示例：** 控制电机 2、3、4 执行不同命令

```
发送: 00 AA 00 22 
      02 FD 01 05 DC 08 00 00 7D 00 00 00 6B (电机2: 位置模式)
      03 FD 00 03 E8 0A 00 00 FA 00 01 01 6B (电机3: 位置模式)
      04 36 6B (电机4: 读取位置)
      6B
```

**注意：**
1. 只有地址 1 电机会回复确认收到命令，避免总线冲突
2. Modbus-RTU 协议暂不支持多电机命令

---

## 附录：适用说明

本文档适用于 ZDT X42S/Y42 系列闭环步进电机的 Emm 固件。文档中的所有命令均为 Emm 固件支持的命令格式。
